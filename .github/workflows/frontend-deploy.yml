name: Frontend Deploy Service

on:
  push:
    branches: [ "main", "githubaction_prac" ]
    paths:
      - 'apps/frontend/**'
  workflow_dispatch:

jobs:
  frontend:
    name: Frontend CI/CD
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        #cache: 'npm'
        #cache-dependency-path: apps/frontend/package-lock.json

    - name: Install Dependencies
      working-directory: apps/frontend
      run: npm install
    
    - name: Create .env file
      working-directory: apps/frontend
      run: |
        echo "NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}" > .env.production
        echo "NEXT_PUBLIC_SOCKET_URL=${{ secrets.NEXT_PUBLIC_SOCKET_URL }}" >> .env.production

    - name: Test Frontend
      working-directory: apps/frontend
      run: |
        if npm run | grep -q "test"; then
          npm run test
        else
          echo "No test script found, skipping tests."
        fi

    - name: Build Frontend
      working-directory: apps/frontend
      run: npm run build:production

    # ssh키 등록
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    # 프론트 서버 신원확인
    - name: Add Known Hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.FRONTEND_HOST }} >> ~/.ssh/known_hosts

    # 명령 자체는 github에서 돌아가지만 deploy내부에 ssh실행 명령어가 존재
    - name: Deploy Frontend
      working-directory: apps/frontend
      run: |
        make deploy DEPLOY_SERVERS="ec2-user@${{ secrets.FRONTEND_HOST }}" DEPLOY_PATH="/home/ec2-user/ktb-chat-frontend"
